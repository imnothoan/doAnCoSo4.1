--- websocket.js.orig	2025-12-04 18:21:19.022824642 +0000
+++ websocket.js	2025-12-04 18:21:46.532223296 +0000
@@ -264,6 +264,68 @@
       }
     });
 
+    // IMPROVED: Handle notification when user joins a community
+    // This ensures the community conversation exists and user is added to it
+    socket.on("notify_community_conversation", async ({ communityId, username }) => {
+      try {
+        console.log(`ðŸ“¢ User ${username} notified join for community ${communityId}`);
+        
+        // Get or create community conversation
+        let conversationId;
+        const { data: existingConv } = await supabase
+          .from("conversations")
+          .select("id")
+          .eq("community_id", communityId)
+          .single();
+
+        if (existingConv) {
+          conversationId = existingConv.id;
+          console.log(`Found existing conversation ${conversationId} for community ${communityId}`);
+        } else {
+          // Create conversation for this community if it doesn't exist
+          const { data: newConv, error: convErr } = await supabase
+            .from("conversations")
+            .insert([{
+              type: "community",
+              community_id: communityId,
+              created_by: username,
+            }])
+            .select("id")
+            .single();
+
+          if (convErr) {
+            console.error("Error creating community conversation:", convErr);
+            return;
+          }
+          conversationId = newConv.id;
+          console.log(`Created new conversation ${conversationId} for community ${communityId}`);
+        }
+
+        // Add user to conversation members if not already there
+        await supabase
+          .from("conversation_members")
+          .upsert(
+            [{ conversation_id: conversationId, username }],
+            { onConflict: "conversation_id,username" }
+          );
+
+        console.log(`Added ${username} to conversation ${conversationId} members`);
+
+        // Emit event back to the user to join the community chat
+        socket.emit("community_conversation_ready", {
+          communityId,
+          conversationId,
+        });
+
+        // Auto-join the room for them
+        const roomName = `community_chat_${communityId}`;
+        socket.join(roomName);
+        console.log(`âœ… Auto-joined ${username} to community chat room ${roomName}`);
+      } catch (err) {
+        console.error("notify_community_conversation error:", err);
+      }
+    });
+
     // ==================== Community Chat Events ====================
 
     // Join a community chat room
@@ -341,6 +403,26 @@
 
           if (convErr) throw convErr;
           conversationId = newConv.id;
+
+          // IMPROVED: When creating a new conversation, add all approved members to conversation_members
+          const { data: allMembers } = await supabase
+            .from("community_members")
+            .select("username")
+            .eq("community_id", communityId)
+            .eq("status", "approved");
+
+          if (allMembers && allMembers.length > 0) {
+            const memberEntries = allMembers.map(m => ({
+              conversation_id: conversationId,
+              username: m.username
+            }));
+            
+            await supabase
+              .from("conversation_members")
+              .upsert(memberEntries, { onConflict: "conversation_id,username" });
+            
+            console.log(`Added ${allMembers.length} members to new community conversation ${conversationId}`);
+          }
         }
 
         // 3. Insert message
